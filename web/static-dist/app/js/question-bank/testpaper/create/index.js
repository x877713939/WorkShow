!function(c){function t(t){for(var e,i,n=t[0],a=t[1],s=t[2],o=0,r=[];o<n.length;o++)i=n[o],Object.prototype.hasOwnProperty.call(d,i)&&d[i]&&r.push(d[i][0]),d[i]=0;for(e in a)Object.prototype.hasOwnProperty.call(a,e)&&(c[e]=a[e]);for(h&&h(t);r.length;)r.shift()();return u.push.apply(u,s||[]),l()}function l(){for(var t,e=0;e<u.length;e++){for(var i=u[e],n=!0,a=1;a<i.length;a++){var s=i[a];0!==d[s]&&(n=!1)}n&&(u.splice(e--,1),t=o(o.s=i[0]))}return t}var i={},d={245:0},u=[];function o(t){if(i[t])return i[t].exports;var e=i[t]={i:t,l:!1,exports:{}};return c[t].call(e.exports,e,e.exports,o),e.l=!0,e.exports}o.m=c,o.c=i,o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(i,n,function(t){return e[t]}.bind(null,n));return i},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/static-dist/";var e=window.webpackJsonp=window.webpackJsonp||[],n=e.push.bind(e);e.push=t,e=e.slice();for(var a=0;a<e.length;a++)t(e[a]);var h=n;u.push([660,0]),l()}({131:function(t,e,i){"use strict";var n=i(0),a=i.n(n),n=i(1),s=i.n(n),n=function(){function e(t){a()(this,e),this.$element=t,this.initEvent()}return s()(e,[{key:"initEvent",value:function(){var e=this;this.$element.on("click",'[data-role="batch-select"]',function(t){return e._batch2Item(t)}),this.$element.on("click",'[data-role="batch-item"]',function(t){return e._item2Batch(t)})}},{key:"_batch2Item",value:function(t){t=$(t.currentTarget).prop("checked");this.$element.find('[data-role="batch-select"]').prop("checked",t),this.$element.find('[data-role="batch-item"]:visible').prop("checked",t)}},{key:"_item2Batch",value:function(){this.$element.find('[data-role="batch-item"]').length==this.$element.find('[data-role="batch-item"]:checked').length?this.$element.find('[data-role="batch-select"]').prop("checked",!0):this.$element.find('[data-role="batch-select"]').prop("checked",!1)}}]),e}();e.a=n},660:function(t,e,i){"use strict";i.r(e);var e=i(18),n=i.n(e),e=i(12),a=i.n(e),e=i(0),s=i.n(e),e=i(1),o=i.n(e),r=i(16),c=i(131),e=i(377);new(function(){function e(t){s()(this,e),this.$form=t,this.$description=this.$form.find('[name="description"]'),this.$questionForm=$("#testpaper-items-manager"),this.validator=null,this.difficultySlider=null,this.scoreSlider=null,this.$scoreModal=$(".js-score-modal"),this.$modal=$("#testpaper-confirm-modal"),this.sections=[],this.questionsCount=0,this.$typeNav=this.$form.find("#testpaper-question-nav"),new c.a(this.$questionForm),this._initEvent(),this._initValidate(),this._initScoreValidator(),this._initTypeSort()}return o()(e,[{key:"_initEvent",value:function(){var i=this;this.$form.on("click",".js-request-save",function(t){return i._confirmSave(t)}),this.$modal.on("click",".js-confirm-submit",function(t){return i._submitSave(t)}),this.$typeNav.on("click","li",function(t){return i._changeNav(t)}),this.$form.on("click",'[data-role="item-delete-btn"]',function(t){return i.deleteQuestion(t)}),this.$form.on("click",'[data-role="batch-delete-btn"]',function(t){return i.batchDelete(t)}),this.$form.on("click",'[data-role="set-score-btn"]',function(t){return i.showScoreModal(t)}),this.$form.on("click",".js-pick-modal",function(t){return i.showPickModal(t)}),this.$form.on("lengthChange",'[data-role="question-body"]',function(t){return i.changeQuestionCount(t)}),this.$scoreModal.on("click",".js-batch-score-confirm",function(t){return i.batchSetScore(t)}),$(".modal").on("selectQuestion",function(t,e){return i.selectQuestion(t,e)}),this.initSortList()}},{key:"_confirmSave",value:function(){var n,t=this._validateScore();this.validator.form()&&t&&(this.questionsCount=0,this.questions=[],this.sections=[],t=this._calTestpaperStats(),n="",$.each(t,function(t,e){var i="<tr>";i+="<td>".concat(e.name,"</td>"),i+="<td>".concat(e.count,"</td>"),i+="<td>".concat(e.score.toFixed(1),"</td>"),n+=i+="</tr>"}),this.$modal.find(".detail-tbody").html(n),this.$modal.modal("show"))}},{key:"_calTestpaperStats",value:function(){var o={},r=this,e=1;this.$typeNav.find("li").each(function(){var n=$(this).find("a").data("type"),t=$(this).find("a").data("name"),a=1,s=[];o[n]={name:t,count:0,score:0,missScore:0},r.$questionForm.find("#testpaper-table-"+n).find(".js-item").each(function(){var t=$(this).data("type"),e={id:$(this).data("id"),seq:a++},i=[];"material"==t?$(this).nextUntil(".js-item").each(function(){var t=r.getItemQuestion(this);i.push(t),o[n].count++,o[n].score+=t.score}):(t=r.getItemQuestion(this),i.push(t),o[n].score+=t.score,o[n].count++),e.questions=i,s.push(e)}),0<s.length&&r.sections.push({name:t,seq:e++,items:s})});var i={name:Translator.trans("activity.testpaper_manage.question_total_score"),count:0,score:0};return $.each(o,function(t,e){i.count+=e.count,i.score+=e.score}),o.total=i,r.questionsCount=i.count,o}},{key:"getItemQuestion",value:function(t){var e=a()($(t).find(".js-question-score").attr("data-score")),e={id:$(t).data("questionId"),score:e};return 0<$(t).find(".js-miss-score").length&&(e.miss_score=a()($(t).find(".js-miss-score").data("missScore"))),e}},{key:"_validateScore",value:function(){var i=!0;return 0===this.$form.find(".js-question-score").length&&(cd.message({type:"danger",message:Translator.trans("activity.testpaper_manage.question_required_error_hint")}),i=!1),this.$form.find(".js-question-score").each(function(){var t=$(this).closest("tr").data("type"),e=$(this).data("score");"0"==e&&"material"!==t&&(cd.message({type:"danger",message:Translator.trans("activity.testpaper_manage.question_score_empty_hint")}),i=!1),/^(([1-9]{1}\d{0,2})|([0]{1}))(\.(\d){1})?$/.test(e)||"material"===t||(cd.message({type:"danger",message:Translator.trans("activity.testpaper_manage.question_score_error_hint")}),i=!1)}),i}},{key:"_changeNav",value:function(t){var e=$(t.currentTarget),t=e.children().data("type");this.currentType=t,this.$typeNav.find("li").removeClass("active"),e.addClass("active"),this.$form.find(".js-question-table").addClass("hide"),this.$form.find("#testpaper-table-"+t).removeClass("hide"),this.$form.find('[data-role="batch-select"]').prop("checked",!1),this.$form.find('[data-role="batch-item"]').prop("checked",!1)}},{key:"deleteQuestion",value:function(t){t.stopPropagation();var e=$(t.currentTarget),i=e.closest("tr").data("id"),t=e.closest("tbody");t.find('[data-id="'+i+'"]').remove(),e.closest("tr").remove(),t.trigger("lengthChange"),this.refreshSeqs(t.data("type"))}},{key:"batchDelete",value:function(t){var t=$(t.currentTarget).parents(".js-question-table").find("tbody"),e=this;this.$form.find('[data-role="batch-item"]:checked').each(function(){var t=$(this).val();"material"===$(this).closest("tr").data("type")&&e.$form.find('[data-parent-id="'+t+'"]').remove(),$(this).closest("tr").remove()}),t.trigger("lengthChange")}},{key:"showScoreModal",value:function(){var e,i,t=this.$form.find('[data-role="batch-item"]:checked');0<t.length&&(e=this,i=["choice","uncertain_choice","material"],t.each(function(){var t=e.$scoreModal.find(".js-miss-score-field");-1!==$.inArray($(this).closest("tr").data("type"),i)?t.removeClass("hidden"):t.addClass("hidden")}),this.$scoreModal.modal("show"))}},{key:"batchSetScore",value:function(){var t,e,i,n;this.scoreValidator.form()&&(t=this.$scoreModal.find('input[name="score"]'),e=this.$scoreModal.find('input[name="missScore"]'),i={score:a()(t.val()),missScore:""==e.val()?0:a()(e.val())},(n=this).$form.find('[data-role="batch-item"]:checked').each(function(){n.setScore($(this).parents("tr"),i)}),cd.message({type:"success",message:Translator.trans("subject.score_update_success")}),this.$scoreModal.modal("hide"),t.val(""),e.val(""))}},{key:"setScore",value:function(t,e){var i=t.find(".js-question-score");i.text(e.score),i.attr("data-score",e.score),0<t.find(".js-miss-score").length&&((t=t.find(".js-miss-score")).text(e.missScore),t.attr("data-miss-score",e.missScore))}},{key:"refreshSeqs",value:function(t){var i=1,t=this.$form.find("#testpaper-table-"+t);t.find("tbody tr").each(function(t,e){e=$(e);e.hasClass("is-sub-question")||(e.find("td.seq").html(i),i++)}),t.find('[name="questionLength"]').val(0<i-1?i-1:null)}},{key:"changeQuestionCount",value:function(t){var e=$(t.currentTarget),i=e.data("type"),t=0,t=("material"===i?e.find("tr.is-sub-question"):e.find("tr")).length;$(".js-count-"+i).html("("+t+")")}},{key:"showPickModal",value:function(t){var e=[],t=$(t.currentTarget);this.$form.find('[name="itemIds[]"]').each(function(){e.push($(this).val())});var i=$("#modal").modal();$.get(t.data("url"),{exclude_ids:e.join(",")},function(t){i.html(t)})}},{key:"selectQuestion",value:function(t,e){var i=this.$form.find(".js-pick-modal").data("pickUrl"),n=this;$.post(i,{typeQuestions:e},function(t){t&&$.each(t,function(t,e){var i=n.$questionForm.find("#testpaper-table-"+t).find(".testpaper-table-tbody");i.append(e),i.trigger("lengthChange"),n.refreshSeqs(t)})})}},{key:"_initEditor",value:function(t){var e,i=this;0<this.$description.length&&((e=CKEDITOR.replace(this.$description.attr("id"),{toolbar:"Simple",fileSingleSizeLimit:app.fileSingleSizeLimit,filebrowserImageUploadUrl:this.$description.data("imageUploadUrl"),height:100})).on("change",function(){i.$description.val(Object(r.c)(e.getData()))}),e.on("blur",function(){i.$description.val(Object(r.c)(e.getData())),t.form()}))}},{key:"_initValidate",value:function(){this.validator=this.$form.validate({rules:{name:{required:!0,maxlength:50,trim:!0},description:{maxlength:500,trim:!0}},messages:{name:{required:Translator.trans("activity.testpaper_manage.input_title_hint"),maxlength:Translator.trans("site.maxlength_hint",{length:50})},description:{required:Translator.trans("activity.testpaper_manage.input_description_hint"),maxlength:Translator.trans("site.maxlength_hint",{length:500})}}}),this._initEditor(this.validator)}},{key:"_initScoreValidator",value:function(){this.scoreValidator=$("#batch-set-score-form").validate({onkeyup:!1,rules:{score:{required:!0,max:999,min:0,es_score:!0},missScore:{required:!1,max:999,min:0,noMoreThan:"#score",es_score:!0}},messages:{missScore:{noMoreThan:Translator.trans("subject.miss_score_no_more_than_score")}}}),$.validator.addMethod("noMoreThan",function(t,e,i){return""==t||a()(t)<=a()($(i).val())},"Please enter a lesser value.")}},{key:"_submitSave",value:function(t){var e=$(t.currentTarget);2e3<this.questionsCount?cd.message({type:"danger",message:Translator.trans("activity.testpaper_manage.questions_length_hint")}):(e.button("loading").addClass("disabled"),t={name:this.$form.find("#name-field").val(),description:this.$form.find("#description-field").val()},e=n()(this.sections),$.post(this.$form.data("url"),{baseInfo:t,sections:e},function(t){t.goto&&(window.location.href=t.goto)}))}},{key:"_initTypeSort",value:function(){var s;$("#testpaper-question-nav").sortable({handle:".js-move-icon",itemSelector:".question-type-table",placeholder:'<li class="question-type-table question-type-placehoder"></li>',onDrop:function(t){t.removeClass("dragged").removeAttr("style"),$("body").removeClass("dragging")},onDragStart:function(t,e,i){var n=t.offset(),a=e.rootGroup.pointer;s={left:a.left-n.left,top:a.top-n.top},i(t,e)},onDrag:function(t,e){var i=t.height(),n=t.width();t.css({left:e.left-s.left,top:e.top-s.top}),$(".question-type-placehoder").css({height:i,width:n})}})}},{key:"initSortList",value:function(){var s,a=this,t=this.$form.find("tbody"),e=t.hasClass("js-homework-table")?"":"<td></td>",e='<tr class="question-placehoder js-placehoder"><td></td><td></td><td></td><td></td><td></td><td></td><td></td>'.concat(e,"</tr>");t.sortable({containerPath:"> tr",containerSelector:"tbody",itemSelector:"tr.is-question",placeholder:e,exclude:".notMoveHandle",onDragStart:function(t,e,i){t.hasClass("have-sub-questions")||$(".js-have-sub").removeClass("is-question");var n=t.offset(),a=e.rootGroup.pointer;s={left:a.left-n.left,top:a.top-n.top},i(t,e)},onDrag:function(t,e){var i=t.height();t.css({left:e.left-s.left,top:e.top-s.top}),$(".js-placehoder").css({height:i})},onDrop:function(t,e,i){var n;i(t,e),t.hasClass("have-sub-questions")?(n=t.parents("tbody")).find("tr.is-question").each(function(){var t=$(this);n.find("[data-id="+t.data("id")+"].is-sub-question").detach().insertAfter(t)}):$(".js-have-sub").addClass("is-question"),a.refreshSeqs(t.data("type"))}})}}]),e}())($("#testpaper-form"))}});